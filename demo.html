<!DOCTYPE html>
<html lang="en">
	<head>
		<title>MusicMapped.com</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #0e0e0e;
				background-color: #0e0e0e;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 5px;
				font-family: Monospace;
				font-size: 13px;
				text-align: center;
				font-weight: bold;
			}
			a {
				color: #0e0e0e;
			}
		</style>

		<!-- List items with avatar and action -->
		<style>
			.demo-list-control {
			    width: 230px;
			}

			.demo-list-radio {
			    display: inline;
			}

		</style>
	</head>




	<body>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.amber-orange.min.css" /> 
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://rawgit.com/mrdoob/stats.js/master/build/stats.min.js"></script>

		<!-- The drawer is always open in large screens. The header is always shown,
		  even in small screens. -->
		<div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer
            		mdl-layout--fixed-header">
            <header class="mdl-layout__header">
                <div id='header' class="mdl-layout__header-row">
                    <div class="mdl-layout-spacer"></div>
					<nav class="mdl-navigation">
						<h6 id="filename"></h6>
					</nav>
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable
                                mdl-textfield--floating-label mdl-textfield--align-right">

	                    <div class="mdl-textfield__expandable-holder">
	                        <input class="mdl-textfield__input" type="text" name="sample"
	                                  id="fixed-header-drawer-exp">
	                    </div>
                    </div>
                </div>
			</header>
		        <div class="mdl-layout__drawer" id='drawer'>



		            <span class="mdl-layout-title"><p><h5>Music <img src="YOmusic.png" alt="Mountain View" style="width:50px;height:50px;" onclick="updateGraph();yo_Clicked = true;" > Mappr</h5></p>

					</span>
	            	<nav class="mdl-navigation">

						<ul class="demo-list-control mdl-list">
							<li class="mdl-list__item">
								<span class="mdl-list__item-primary-content">
									modelA
								</span>
								<span class="mdl-list__item-secondary-action">
									<label class="demo-list-radio mdl-radio mdl-js-radio mdl-js-ripple-effect" for="feature-list-option-1">
										<input type="radio" id="feature-list-option-1" class="mdl-radio__button" name="options" value="modelA" oninput="updateGraph()" onchange="updateGraph()" checked />
									</label>
								</span>
							</li>

							<li class="mdl-list__item">
								<span class="mdl-list__item-primary-content">
									modelB
								</span>
								<span class="mdl-list__item-secondary-action">
									<label class="demo-list-radio mdl-radio mdl-js-radio mdl-js-ripple-effect" for="feature-list-option-2">
										<input type="radio" id="feature-list-option-2" class="mdl-radio__button" name="options" value="modelB" oninput="updateGraph()" onchange="updateGraph()" />
									</label>
								</span>
							</li>
						</ul>
					</nav>

						<hr>

					<nav class="mdl-navigation">
						<ul class="demo-list-control mdl-list">
							<li class="mdl-list__item">
								<span class="mdl-list__item-primary-content">
									UMAP
								</span>
								<span class="mdl-list__item-secondary-action">
									<label class="demo-list-radio mdl-radio mdl-js-radio mdl-js-ripple-effect" for="method-list-option-1">
										<input type="radio" id="method-list-option-1" class="mdl-radio__button" name="methodoptions" value="umap" oninput="updateGraph()" onchange="updateGraph()" checked />
									</label>
								</span>
							</li>

							<li class="mdl-list__item">
								<span class="mdl-list__item-primary-content">
									t-SNE
								</span>
								<span class="mdl-list__item-secondary-action">
									<label class="demo-list-radio mdl-radio mdl-js-radio mdl-js-ripple-effect" for="method-list-option-2">
										<input type="radio" id="method-list-option-2" class="mdl-radio__button" name="methodoptions" value="tsne" oninput="updateGraph()" onchange="updateGraph()" />
									</label>
								</span>
							</li>


							<li class="mdl-list__item">
								<span class="mdl-list__item-primary-content">
									PCA
								</span>
								<span class="mdl-list__item-secondary-action">
									<label class="demo-list-radio mdl-radio mdl-js-radio mdl-js-ripple-effect" for="method-list-option-3">
										<input type="radio" id="method-list-option-3" class="mdl-radio__button" name="methodoptions" value="pca" oninput="updateGraph()" onchange="updateGraph()" />
									</label>
								</span>
							</li>
						</ul>

						<div id="sliders">
							<p style="width:230px">
								<div class="mdl-card__supporting-text">
									<p id="slider-text-1">Neighbours</p>
								</div>
								<input class="mdl-slider mdl-js-slider" type="range" id="slider1" min="1" max="5" step="1" value="0" oninput="updateGraph()" onchange="updateGraph()">
								<div class="mdl-card__supporting-text">
									<p id="slider-text-2">Distances</p>
								</div>
								<input class="mdl-slider mdl-js-slider" type="range" id="slider2" min="1" max="5" step="1" value="0" oninput="updateGraph()" onchange="updateGraph()">
							</p>
						</div>

		            	<a class="mdl-navigation__link" href="https://github.com/codeJRV/MusicMapz">Blog</a>
		            	<a class="mdl-navigation__link" href="https://github.com/codeJRV/MusicMapz">Code</a>
	            	</nav>
		        </div>
		    <main class="mdl-layout__content">
			    <div class="page-content">
					<!-- Your content goes here -->

					<div id="container"></div>
				</div>
		    </main>
		</div>

		<script type="text/javascript" src="data.json"></script>
		<script src='webaudiox.js'></script>

		<script>

			// create WebAudio API context
			var context = new AudioContext()

			// Create lineOut
			var lineOut = new WebAudiox.LineOut(context)
			lineOut.volume = 0.4;

			var data = JSON.parse(d);

			function getData(method, feature, a, b) {
				var key;
				if (method.toString() == "pca") {
					key = method.toString() + feature.toString();
				} else {
					key = method.toString() + feature.toString() + a.toString() + b.toString();
				}
				return data[key];
			}

			var filePaths = data['filenames'];


			var renderer, scene, camera, stats;
			var pointclouds;
			var raycaster;
			var mouse = new THREE.Vector2();
			var intersection = null;
			var spheres = [];
			var spheresIndex = 0;
			var clock;
			var mouseHasMoved = false;
			var sound = null;
			var interpolating = false;
			var interpolatingAmount = 0;
			var interpolationSpeed = 0.01;
			var target = null;
			var previousSampleIndex = -1;
			var threshold = 0.1;
			var pointSize = 3;
			var width = 150;
			var length = 150;
			var yo_Clicked = false;

			var drawerWidth = document.getElementById("drawer").clientWidth;
			var titleHeight = document.getElementById("header").clientHeight;
			var renderWidth = window.innerWidth - drawerWidth;
			var renderHeight = window.innerHeight - titleHeight;

			init();
			animate();

			function updateGraph() {
				var slider1 = parseInt(document.getElementById("slider1").value) - 1;
				var slider2 = parseInt(document.getElementById("slider2").value) - 1;

				var method = null;
				var methodOptions = document.getElementsByClassName('mdl-radio__button');
				for (var i = 0; methodOptions[i]; ++i) {
					let id = methodOptions[i].id.toString();
					if (methodOptions[i].checked && (id.indexOf("method") != -1)) {
						method = methodOptions[i].value;
						break;
					}
				}

				var feature = null;
				var featureOptions = document.getElementsByClassName('mdl-radio__button');
				for (var i = 0; featureOptions[i]; ++i) {
					let id = featureOptions[i].id.toString();
					if (featureOptions[i].checked && (id.indexOf("feature") != -1)) {
						feature = featureOptions[i].value;
						break;
					}
				}

				if (method == "umap") {
					document.getElementById("sliders").style.visibility = "visible";
					document.getElementById("slider-text-1").innerHTML = "Neighbours";
					document.getElementById("slider-text-2").innerHTML = "Distances";
				} else if (method == "tsne") {
					document.getElementById("sliders").style.visibility = "visible";
					document.getElementById("slider-text-1").innerHTML = "Perplexity";
					document.getElementById("slider-text-2").innerHTML = "Iterations";
				} else if (method == "pca" || yo_Clicked == true) {
					document.getElementById("sliders").style.visibility = "hidden";
					method="pca";
					yo_Clicked=false;
				}

				let targetData = getData(method, feature, slider1, slider2);
				target = generatePositionsFromData(targetData);
				interpolating = true;
				interpolatingAmount = 0;
			}

			function generatePositionsFromData(data) {

				var positions = new Float32Array(data.length * 3);
				for (var i = 0; i < data.length; ++i) {

					let x = data[i]['coordinates'][0] - 0.5;
					let y = data[i]['coordinates'][1] - 0.5;
					let z = 0;

					positions[3 * i] = x;
					positions[3 * i + 1] = y;
					positions[3 * i + 2] = z;
				}

				return positions;
			}

			function generatePointCloudGeometry(data) {

				var geometry = new THREE.BufferGeometry();
				var positions = generatePositionsFromData(data);

				var colors = new Float32Array(data.length * 3);
				var color = new THREE.Color();
				for (var i = 0; i < data.length; ++i) {
					
					//Integrate class labelling here somehow
					var hue = data[i]['coordinates'][2]/10;  
					console.log(hue)
					color.setHSL(hue, .8, .5);

					colors[3 * i] = color.r;
					colors[3 * i + 1] = color.g;
					colors[3 * i + 2] = color.b;
				}

				geometry.addAttribute('position', new THREE.BufferAttribute(positions, 3));
				geometry.addAttribute('color', new THREE.BufferAttribute(colors, 3));
				geometry.computeBoundingBox();

				return geometry;
			}

			function generatePointcloud(data) {

				var geometry = generatePointCloudGeometry(data);

				var material = new THREE.PointsMaterial({
					size: pointSize,
					vertexColors: THREE.VertexColors,
					sizeAttenuation: false
				});
				var pointcloud = new THREE.Points(geometry, material);
				return pointcloud;

			}

			function init() {

				var container = document.getElementById('container');

				scene = new THREE.Scene();

				clock = new THREE.Clock();

				const near_plane = 2;
				const far_plane = 100;


				// Set up camera and scene
				camera = new THREE.PerspectiveCamera(
				    20,
				    renderWidth / renderHeight,
				    near_plane,
				    far_plane
				);

				camera.applyMatrix( new THREE.Matrix4().makeTranslation( 0,0,40 ) );

				let jsonData = getData("pca", "modelA", 0, 0);
				var pcBuffer = generatePointcloud(jsonData);
				pcBuffer.scale.set(10, 10, 1);
				pcBuffer.position.set(0, 0, 0);
				scene.add( pcBuffer );

				pointclouds = [ pcBuffer ];

				//

				var sphereGeometry = new THREE.SphereGeometry( 0.1, 32, 32 );
				var sphereMaterial = new THREE.MeshBasicMaterial( { color: 0xff0000 } );

				for ( var i = 0; i < 40; i++ ) {

					var sphere = new THREE.Mesh( sphereGeometry, sphereMaterial );
					scene.add( sphere );
					spheres.push( sphere );

				}

				//
				renderWidth = window.innerWidth - drawerWidth;
				renderHeight = window.innerHeight - titleHeight;
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setClearColor(0x0e0e0e, 1);
				renderer.setSize(renderWidth, renderHeight);
				container.appendChild(renderer.domElement);

				//

				raycaster = new THREE.Raycaster();
				raycaster.params.Points.threshold = threshold;

				//

				stats = new Stats();
				container.appendChild( stats.dom );

				//

				window.addEventListener( 'resize', onWindowResize, false );
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			}

			function onDocumentMouseMove( event ) {

				mouseHasMoved = true;

				titleHeight = document.getElementById("header").clientHeight;

				if (window.innerWidth >= 1024) {
					drawerWidth = document.getElementById("drawer").clientWidth;
					mouse.x = ( (event.clientX - drawerWidth) / renderWidth ) * 2 - 1;
				} else {
					mouse.x = ( event.clientX /renderWidth ) * 2 - 1;
				}
				mouse.y = - ( (event.clientY - titleHeight) / (renderHeight)) * 2 + 1;
			}

			function onWindowResize() {

				renderWidth = window.innerWidth - drawerWidth;
				renderHeight = window.innerHeight - titleHeight;

				camera.aspect = renderWidth / renderHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( renderWidth, renderHeight );

			}

			function animate() {

				requestAnimationFrame(animate);

				if (interpolating) {
					pointclouds[0].geometry.attributes.position.needsUpdate = true;

					var positions = pointclouds[0].geometry.attributes.position.array;

					interpolatingAmount += interpolationSpeed;

					if (interpolatingAmount >= 1.0) {
						interpolating = false;

						for (var i = 0; i < positions.length; ++i) {
							positions[i] = target[i];
						}
					} else {

						for (var i = 0; i < positions.length; i += 3) {
							positions[i] = THREE.Math.lerp(positions[i], target[i], interpolatingAmount);
							positions[i+1] = THREE.Math.lerp(positions[i+1], target[i+1], interpolatingAmount);
						}
					}
				}


				render();
				stats.update();

			}



			var toggle = 0;

			function render() {

				raycaster.setFromCamera(mouse, camera);

				var intersections = raycaster.intersectObjects( pointclouds );
				intersection = (intersections.length) > 0 ? intersections[0] : null;
				var previousSource = null;

				if (toggle > 0.02 && intersection !== null && mouseHasMoved) {

					if (previousSampleIndex != intersection.index) {
						let filepath = filePaths[intersection.index];
						previousSampleIndex = intersection.index;

						// if (playPromise !== undefined) {
						// 	playPromise.then(_ => {
						// 		// Automatic playback started!
						// 		// Show playing UI.
						// 		// We can now safely pause video...
						// 		sound.pause();
						// 		sound.src = '';
						// 		sound.load("vengance_dataset/" + filepath);
						// 		sound.volume = 0.2;
						// 		playPromise = sound.play();
						// 	})
						// 	.catch(error => {
						// 		// Auto-play was prevented
						// 		// Show paused UI.
						// 	});
						// }
						//
						// if (sound == null) {
						// 	sound = new Audio("vengance_dataset/" + filepath);
						// }
						//
						// sound.volume = 0.2;
						// var playPromise = sound.play();

						// load a sound and play it immediatly
						let file = filepath;
						
						context.close();
						delete context;
						context = new AudioContext();
						delete lineOut;
						lineOut = new WebAudiox.LineOut(context);
						lineOut.volume = 0.4;


					    WebAudiox.loadBuffer(context, file, function(buffer){
							// init AudioBufferSourceNode
							
							var WebAudiox	= WebAudiox	|| {}

					        var source  = context.createBufferSource();
							source.buffer = buffer
							
					        source.connect(lineOut.destination)

							// start the sound now

							source.start(0);
						
					    });

						document.getElementById("filename").innerHTML = filepath;
					}

					spheres[spheresIndex].position.copy(intersection.point);
					spheres[spheresIndex].scale.set(1, 1, 1);
					spheresIndex = (spheresIndex + 1) % spheres.length;

					toggle = 0;

				}

				for (var i = 0; i < spheres.length; i++) {

					var sphere = spheres[i];
					sphere.scale.multiplyScalar(0.98);
					sphere.scale.clampScalar(0.01, 1);

				}

				toggle += clock.getDelta();

				renderer.render(scene, camera);

			}

		</script>

	</body>

</html>